<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Linux内核源码阅读 - 编程日志</title><meta name=Description content="Linux内核源码阅读"><meta property="og:title" content="Linux内核源码阅读">
<meta property="og:description" content="Linux内核源码阅读"><meta property="og:type" content="article"><meta property="og:url" content="https://mengdemao.github.io/read_linux/"><meta property="og:image" content="https://mengdemao.github.io/images/avatar.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-12T12:56:02+08:00"><meta property="article:modified_time" content="2023-12-23T17:10:11+08:00"><meta property="og:site_name" content="编程日志"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://mengdemao.github.io/images/avatar.webp"><meta name=twitter:title content="Linux内核源码阅读"><meta name=twitter:description content="Linux内核源码阅读"><meta name=application-name content="DoIt"><meta name=apple-mobile-web-app-title content="DoIt"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://mengdemao.github.io/read_linux/><link rel=prev href=https://mengdemao.github.io/nodejs/><link rel=next href=https://mengdemao.github.io/uboot/><link rel=stylesheet href=/css/main.d5cb6f29e0750a13b17688d628b04d50f9fbbd32e0629ccc0dcf796a299ae226.css integrity="sha256-1ctvKeB1ChOxdojWKLBNUPn7vTLgYpzMDc95aima4iY="><link rel=stylesheet href=/lib/normalize/normalize.min.055364f5be272caa092b0e6654c165828707f8ab971e2656383a6d6392bc345e.css integrity="sha256-BVNk9b4nLKoJKw5mVMFlgocH+KuXHiZWODptY5K8NF4="><link rel=stylesheet href=/css/color.b0a0f8c429ce52dfa2805b5f9e99ccdae1e8fbfd9adf4f3ddb409d8201fc0c5a.css integrity="sha256-sKD4xCnOUt+igFtfnpnM2uHo+/2a308920CdggH8DFo="><link rel=stylesheet href=/css/style.min.756198aff89672b591eca05beff565af360b75389a67da7c9d2ff34dce397c56.css integrity="sha256-dWGYr/iWcrWR7KBb7/VlrzYLdTiaZ9p8nS/zTc45fFY="><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.43202d5486e011f9684a17bd6846b5c16a2619002bfc783f7e32e20dfb6bf857.css integrity="sha256-QyAtVIbgEfloShe9aEa1wWomGQAr/Hg/fjLiDftr+Fc="><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.43202d5486e011f9684a17bd6846b5c16a2619002bfc783f7e32e20dfb6bf857.css integrity="sha256-QyAtVIbgEfloShe9aEa1wWomGQAr/Hg/fjLiDftr+Fc="></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.5fbaeb9f8e25d7e0143bae61d4b1802c16ce7390b96ceb2d498b0d96ff4c853f.css integrity="sha256-X7rrn44l1+AUO65h1LGALBbOc5C5bOstSYsNlv9MhT8="><noscript><link rel=stylesheet href=/lib/animate/animate.min.5fbaeb9f8e25d7e0143bae61d4b1802c16ce7390b96ceb2d498b0d96ff4c853f.css integrity="sha256-X7rrn44l1+AUO65h1LGALBbOc5C5bOstSYsNlv9MhT8="></noscript><meta name=google-site-verification content="MQ8DNu27ayX6B_4ObiEDK09vGr1fdy7kOAnbd09hJk4"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Linux内核源码阅读","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https://mengdemao.github.io/read_linux/"},"image":["https://mengdemao.github.io/images/Apple-Devices-Preview.png"],"genre":"posts","keywords":"Linux Kernel","wordcount":4782,"url":"https://mengdemao.github.io/read_linux/","datePublished":"2023-02-12T12:56:02+08:00","dateModified":"2023-12-23T17:10:11+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"https://mengdemao.github.io/images/avatar.webp","width":528,"height":560}},"author":{"@type":"Person","name":"mengdemao"},"description":"Linux内核源码阅读"}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=编程日志><span class=header-title-pre><i class='far fa-edit fa-fw'></i></span><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/series/>系列 </a><a class=menu-item href=/authors/>作者 </a><a class=menu-item href=/showcase/>作品 </a><a class=menu-item href=/categories/documentation/>文档 </a><a class=menu-item href=/about/>关于 </a><a class=menu-item href=https://github.com/mengdemao/github.io title=GitHub rel="noopener noreferrer" target=_blank><i class='fab fa-github fa-fw'></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=javascript:void(0); class="menu-item theme-select" title=切换主题><i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-desktop title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=编程日志><span class=header-title-pre><i class='far fa-edit fa-fw'></i></span><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/series/ title>系列</a><a class=menu-item href=/authors/ title>作者</a><a class=menu-item href=/showcase/ title>作品</a><a class=menu-item href=/categories/documentation/ title>文档</a><a class=menu-item href=/about/ title>关于</a><a class=menu-item href=https://github.com/mengdemao/github.io title=GitHub rel="noopener noreferrer" target=_blank><i class='fab fa-github fa-fw'></i></a><a href=javascript:void(0); class="menu-item theme-select" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-mobile title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#建立环境>建立环境</a><ul><li><a href=#崩溃内核>崩溃内核</a><ul><li><a href=#安装拯救内核>安装拯救内核</a></li><li><a href=#启动kdump服务>启动kdump服务</a></li></ul></li><li><a href=#基础环境>基础环境</a></li><li><a href=#调试环境eclipse>调试环境(eclipse)</a></li><li><a href=#调试环境vscode>调试环境(vscode)</a></li><li><a href=#调试环境原始gdb>调试环境(原始gdb)</a></li></ul></li><li><a href=#系统构建>系统构建</a><ul><li><a href=#vmlinux生成过程>vmlinux生成过程</a></li><li><a href=#vmlinuxbin生成过程>vmlinux.bin生成过程</a></li><li><a href=#headero>header.o</a></li><li><a href=#setupbin生成过程>setup.bin生成过程</a></li><li><a href=#最后生成>最后生成</a></li></ul></li><li><a href=#根文件系统>根文件系统</a><ul><li><a href=#编译busybox>编译busybox</a></li><li><a href=#安装c库>安装C库</a></li></ul></li><li><a href=#initramfs>initramfs</a><ul><li><a href=#hello-initramfs>Hello initramfs</a></li></ul></li><li><a href=#启动分析>启动分析</a><ul><li><a href=#启动前夕>启动前夕</a></li><li><a href=#start_kernel>start_kernel</a></li><li><a href=#reset_init>reset_init</a></li><li><a href=#设置init任务堆栈>设置<code>init</code>任务堆栈</a></li><li><a href=#设置smp的cpu-id>设置smp的CPU ID</a></li><li><a href=#激活启动cpu>激活启动CPU</a></li><li><a href=#设置架构>设置架构</a></li><li><a href=#mm_init_cpumask>mm_init_cpumask</a></li><li><a href=#设置命令行command_line>设置命令行<code>command_line</code></a></li><li><a href=#设置cpu>设置CPU</a></li><li><a href=#smp_prepare_boot_cpu>smp_prepare_boot_cpu</a></li><li><a href=#build_all_zonelists>build_all_zonelists</a></li><li><a href=#page_alloc_init>page_alloc_init</a></li><li><a href=#jump_label_init>jump_label_init</a></li><li><a href=#setup_log_buf>setup_log_buf</a></li><li><a href=#pidhash_init>pidhash_init</a></li><li><a href=#vfs_caches_init_early>vfs_caches_init_early</a></li><li><a href=#sort_main_extable>sort_main_extable</a></li><li><a href=#trap_init>trap_init</a></li><li><a href=#mm_init>mm_init</a></li><li><a href=#sched_init>sched_init</a></li><li><a href=#idr_init_cache>idr_init_cache</a></li><li><a href=#rcu_init>rcu_init</a></li></ul></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Linux内核源码阅读</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=https://github.com/mengdemao title=Author target=_blank rel="noopener noreferrer author" class=author>mengdemao</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/linux-kernel/><i class="far fa-folder fa-fw"></i>Linux Kernel</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-02-12>2023-02-12</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2023-12-23>2023-12-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 4782 字&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 10 分钟&nbsp;</div></div><div class=featured-image><img loading=eager src=/featuredImage/03.webp srcset="/featuredImage/03.webp, /featuredImage/03.webp 1.5x, /featuredImage/03.webp 2x" alt=Linux内核源码阅读 title=Linux内核源码阅读 height=auto width=auto></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#建立环境>建立环境</a><ul><li><a href=#崩溃内核>崩溃内核</a><ul><li><a href=#安装拯救内核>安装拯救内核</a></li><li><a href=#启动kdump服务>启动kdump服务</a></li></ul></li><li><a href=#基础环境>基础环境</a></li><li><a href=#调试环境eclipse>调试环境(eclipse)</a></li><li><a href=#调试环境vscode>调试环境(vscode)</a></li><li><a href=#调试环境原始gdb>调试环境(原始gdb)</a></li></ul></li><li><a href=#系统构建>系统构建</a><ul><li><a href=#vmlinux生成过程>vmlinux生成过程</a></li><li><a href=#vmlinuxbin生成过程>vmlinux.bin生成过程</a></li><li><a href=#headero>header.o</a></li><li><a href=#setupbin生成过程>setup.bin生成过程</a></li><li><a href=#最后生成>最后生成</a></li></ul></li><li><a href=#根文件系统>根文件系统</a><ul><li><a href=#编译busybox>编译busybox</a></li><li><a href=#安装c库>安装C库</a></li></ul></li><li><a href=#initramfs>initramfs</a><ul><li><a href=#hello-initramfs>Hello initramfs</a></li></ul></li><li><a href=#启动分析>启动分析</a><ul><li><a href=#启动前夕>启动前夕</a></li><li><a href=#start_kernel>start_kernel</a></li><li><a href=#reset_init>reset_init</a></li><li><a href=#设置init任务堆栈>设置<code>init</code>任务堆栈</a></li><li><a href=#设置smp的cpu-id>设置smp的CPU ID</a></li><li><a href=#激活启动cpu>激活启动CPU</a></li><li><a href=#设置架构>设置架构</a></li><li><a href=#mm_init_cpumask>mm_init_cpumask</a></li><li><a href=#设置命令行command_line>设置命令行<code>command_line</code></a></li><li><a href=#设置cpu>设置CPU</a></li><li><a href=#smp_prepare_boot_cpu>smp_prepare_boot_cpu</a></li><li><a href=#build_all_zonelists>build_all_zonelists</a></li><li><a href=#page_alloc_init>page_alloc_init</a></li><li><a href=#jump_label_init>jump_label_init</a></li><li><a href=#setup_log_buf>setup_log_buf</a></li><li><a href=#pidhash_init>pidhash_init</a></li><li><a href=#vfs_caches_init_early>vfs_caches_init_early</a></li><li><a href=#sort_main_extable>sort_main_extable</a></li><li><a href=#trap_init>trap_init</a></li><li><a href=#mm_init>mm_init</a></li><li><a href=#sched_init>sched_init</a></li><li><a href=#idr_init_cache>idr_init_cache</a></li><li><a href=#rcu_init>rcu_init</a></li></ul></li></ul></nav></div></div><div class=content id=content><p><strong>内核源码阅读</strong></p><ul><li>源码版本: <a href=https://github.com/figozhang/runninglinuxkernel_4.0.git target=_blank rel="noopener noreferrer">Linux 4.0.0</a></li><li>参考书籍:<ol><li>&#171; 奔跑吧Linux内核 &#187;</li><li>&#171; 深度探索linux系统虚拟化:原理与实现 &#187;</li></ol></li></ul><h2 id=建立环境 class=headerLink><a href=#%e5%bb%ba%e7%ab%8b%e7%8e%af%e5%a2%83 class=header-mark></a>1 建立环境</h2><h3 id=崩溃内核 class=headerLink><a href=#%e5%b4%a9%e6%ba%83%e5%86%85%e6%a0%b8 class=header-mark></a>1.1 崩溃内核</h3><p><a href=https://wiki.archlinux.org/title/Kdump target=_blank rel="noopener noreferrer">参考文档</a></p><h4 id=安装拯救内核 class=headerLink><a href=#%e5%ae%89%e8%a3%85%e6%8b%af%e6%95%91%e5%86%85%e6%a0%b8 class=header-mark></a>1.1.1 安装拯救内核</h4><p>下载内核<a href=https://gitlab.archlinux.org/archlinux/packaging/packages/linux-lts.git target=_blank rel="noopener noreferrer">稳定版</a>,修改构建脚本为了和主线内核区分即可</p><p><figure><img loading=lazy src=/read_linux/picture/image-20230806233120552.png srcset="/read_linux/picture/image-20230806233120552.png, /read_linux/picture/image-20230806233120552.png 1.5x, /read_linux/picture/image-20230806233120552.png 2x" alt=image-20230806233120552 title=image-20230806233120552 height=232 width=935></figure></p><p>修改配置脚本<strong>config</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>CONFIG_DEBUG_INFO</span><span class=o>=</span><span class=s>y</span>
</span></span><span class=line><span class=cl><span class=na>CONFIG_CRASH_DUMP</span><span class=o>=</span><span class=s>y</span>
</span></span><span class=line><span class=cl><span class=na>CONFIG_PROC_VMCORE</span><span class=o>=</span><span class=s>y</span>
</span></span></code></pre></td></tr></table></div></div><p>构建此内核</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 更新校验值</span>
</span></span><span class=line><span class=cl>updpkgsums
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 构建内核</span>
</span></span><span class=line><span class=cl>makepkg -s --skippgpcheck
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装程序</span>
</span></span></code></pre></td></tr></table></div></div><p>修改<code>/etc/default/grub</code>,为<strong>crash kernel</strong>配置空间</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gd>- GRUB_CMDLINE_LINUX_DEFAULT=&#34;loglevel=7&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+ GRUB_CMDLINE_LINUX_DEFAULT=&#34;loglevel=7 crashkernel=256M@16M&#34;
</span></span></span></code></pre></td></tr></table></div></div><p>更新grub配置<code>grub-mkconfig</code></p><h4 id=启动kdump服务 class=headerLink><a href=#%e5%90%af%e5%8a%a8kdump%e6%9c%8d%e5%8a%a1 class=header-mark></a>1.1.2 启动kdump服务</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/etc/systemd/system/kdump.service
</span></span><span class=line><span class=cl><span class=o>[</span>Unit<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Description</span><span class=o>=</span>Load dump capture kernel
</span></span><span class=line><span class=cl><span class=nv>After</span><span class=o>=</span>local-fs.target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>/usr/bin/kexec -p <span class=o>[</span>/boot/vmlinuz-linux-kdump<span class=o>]</span> --initrd<span class=o>=[</span>/boot/initramfs-linux-kdump.img<span class=o>]</span> --append<span class=o>=</span><span class=s2>&#34;root=[root-device] single irqpoll maxcpus=1 reset_devices&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>Type</span><span class=o>=</span>oneshot
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Install<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>WantedBy</span><span class=o>=</span>multi-user.target
</span></span></code></pre></td></tr></table></div></div><h3 id=基础环境 class=headerLink><a href=#%e5%9f%ba%e7%a1%80%e7%8e%af%e5%a2%83 class=header-mark></a>1.2 基础环境</h3><ol><li>安装软件</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo apt install qemu
</span></span><span class=line><span class=cl>$ sudo apt install gcc-arm-none-eabi
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>下载源码</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ git clone https://github.com/figozhang/runninglinuxkernel_4.0.git
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>构建运行</li></ol><ul><li>编译32位arm</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>qemu-system-arm -m <span class=m>1024</span> -M virt<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -nographic -smp <span class=m>4</span> -kernel arch/arm/boot/zImage <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -append <span class=s2>&#34;crashkernel=128M root=/dev/vda rootfstype=ext4 rw&#34;</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -drive <span class=k>if</span><span class=o>=</span>none,file<span class=o>=</span>rootfs_debian_arm32.ext4,id<span class=o>=</span>hd0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -device virtio-blk-device,drive<span class=o>=</span>hd0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -netdev user,id<span class=o>=</span>mynet<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -device virtio-net-device,netdev<span class=o>=</span>mynet<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --fsdev local,id<span class=o>=</span>kmod_dev,path<span class=o>=</span>./kmodules,security_model<span class=o>=</span>none<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -device virtio-9p-device,fsdev<span class=o>=</span>kmod_dev,mount_tag<span class=o>=</span>kmod_mount<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -S -s
</span></span></code></pre></td></tr></table></div></div><ul><li>编译64位arm</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>qemu-system-aarch64 -m <span class=m>1024</span> -cpu cortex-a57 -M virt<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -nographic -smp <span class=m>4</span> -kernel arch/arm64/boot/Image <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -append <span class=s2>&#34;noinintrd root=/dev/vda rootfstype=ext4 rw loglevel=8&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -drive <span class=k>if</span><span class=o>=</span>none,file<span class=o>=</span>rootfs_debian_arm64.ext4,id<span class=o>=</span>hd0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -device virtio-blk-device,drive<span class=o>=</span>hd0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --fsdev local,id<span class=o>=</span>kmod_dev,path<span class=o>=</span>./kmodules,security_model<span class=o>=</span>none <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -device virtio-9p-device,fsdev<span class=o>=</span>kmod_dev,mount_tag<span class=o>=</span>kmod_mount<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -netdev user,id<span class=o>=</span>mynet<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -device virtio-net-device,netdev<span class=o>=</span>mynet<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -S -s
</span></span></code></pre></td></tr></table></div></div><ul><li>安装gdb-multiarch</li></ul><blockquote><p>参考资料:<a href=https://aur.archlinux.org/packages/gdb-multiarch target=_blank rel="noopener noreferrer">Archlinux gdb-multiarch构建</a></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 下载代码</span>
</span></span><span class=line><span class=cl>git clone --branch gdb-13-branch https://sourceware.org/git/binutils-gdb.git
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行构建</span>
</span></span><span class=line><span class=cl>mkdir build <span class=o>&amp;&amp;</span> <span class=nb>cd</span> build
</span></span><span class=line><span class=cl>  ../configure <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --enable-targets<span class=o>=</span>all <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --prefix<span class=o>=</span>/build <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --enable-languages<span class=o>=</span>all <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --enable-multilib <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --enable-interwork <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --with-system-readline <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --disable-nls <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --with-python<span class=o>=</span>/usr/bin/python <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --with-system-gdbinit<span class=o>=</span>/etc/gdb/gdbinit
</span></span><span class=line><span class=cl>make -j<span class=sb>`</span>nproc<span class=sb>`</span>
</span></span><span class=line><span class=cl>make install
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改文件名</span>
</span></span><span class=line><span class=cl>mv /usr/bin/gdb /usr/bin/gdb-multiarch
</span></span></code></pre></td></tr></table></div></div><ul><li>运行gdb-multiarch</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 加载执行文件</span>
</span></span><span class=line><span class=cl>$ file vmlinux
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置架构</span>
</span></span><span class=line><span class=cl>$ <span class=nb>set</span> architecture arm
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 远程连接</span>
</span></span><span class=line><span class=cl>$ target remote localhost:1234
</span></span></code></pre></td></tr></table></div></div><h3 id=调试环境eclipse class=headerLink><a href=#%e8%b0%83%e8%af%95%e7%8e%af%e5%a2%83eclipse class=header-mark></a>1.3 调试环境(eclipse)</h3><ol><li>安装eclipse</li></ol><ul><li>安装jdk</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo apt update
</span></span><span class=line><span class=cl>$ sudo apt install default-jre
</span></span></code></pre></td></tr></table></div></div><ul><li>下载<a href=https://www.eclipse.org/downloads/packages/ target=_blank rel="noopener noreferrer">eclipse C/C++</a><figure><img loading=lazy src=/read_linux/picture/image-20230212133122607.png srcset="/read_linux/picture/image-20230212133122607.png, /read_linux/picture/image-20230212133122607.png 1.5x, /read_linux/picture/image-20230212133122607.png 2x" alt=image-20230212133122607 title=image-20230212133122607 height=473 width=1239></figure></li><li>配置调试</li></ul><p><figure><img loading=lazy src=/read_linux/picture/image-20230212162459346.png srcset="/read_linux/picture/image-20230212162459346.png, /read_linux/picture/image-20230212162459346.png 1.5x, /read_linux/picture/image-20230212162459346.png 2x" alt=image-20230212162459346 title=image-20230212162459346 height=693 width=1025></figure></p><p><figure><img loading=lazy src=/read_linux/picture/image-20230212162628909.png srcset="/read_linux/picture/image-20230212162628909.png, /read_linux/picture/image-20230212162628909.png 1.5x, /read_linux/picture/image-20230212162628909.png 2x" alt=image-20230212162628909 title=image-20230212162628909 height=701 width=1028></figure></p><h3 id=调试环境vscode class=headerLink><a href=#%e8%b0%83%e8%af%95%e7%8e%af%e5%a2%83vscode class=header-mark></a>1.4 调试环境(vscode)</h3><p>当然<code>vscode</code>也是相当好用的,作为调试程序</p><ul><li>在当前工程中添加配置文件<strong>launch.json</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;configurations&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;cppdbg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;request&#34;</span><span class=p>:</span> <span class=s2>&#34;launch&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Linux Gdb Server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;program&#34;</span><span class=p>:</span> <span class=s2>&#34;${workspaceRoot}/vmlinux&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;MIMode&#34;</span><span class=p>:</span> <span class=s2>&#34;gdb&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;miDebuggerPath&#34;</span><span class=p>:</span> <span class=s2>&#34;/usr/bin/gdb-multiarch&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;miDebuggerServerAddress&#34;</span><span class=p>:</span> <span class=s2>&#34;localhost:1234&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;cwd&#34;</span><span class=p>:</span> <span class=s2>&#34;${workspaceRoot}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;externalConsole&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>安装调试器</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>yay -S gdb-multiarch
</span></span></code></pre></td></tr></table></div></div><ul><li>启动调试器</li></ul><p><figure><img loading=lazy src=/read_linux/picture/image-20230305211803830.png srcset="/read_linux/picture/image-20230305211803830.png, /read_linux/picture/image-20230305211803830.png 1.5x, /read_linux/picture/image-20230305211803830.png 2x" alt=image-20230305211803830 title=image-20230305211803830 height=728 width=1325></figure></p><p><figure><img loading=lazy src=/read_linux/picture/image-20230305211922693.png srcset="/read_linux/picture/image-20230305211922693.png, /read_linux/picture/image-20230305211922693.png 1.5x, /read_linux/picture/image-20230305211922693.png 2x" alt=image-20230305211922693 title=image-20230305211922693 height=728 width=1366></figure></p><h3 id=调试环境原始gdb class=headerLink><a href=#%e8%b0%83%e8%af%95%e7%8e%af%e5%a2%83%e5%8e%9f%e5%a7%8bgdb class=header-mark></a>1.5 调试环境(原始gdb)</h3><ul><li>安装gdbgui</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 安装</span>
</span></span><span class=line><span class=cl>pip install gdbgui
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设计</span>
</span></span><span class=line><span class=cl>pip install --upgrade gdbgui
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 卸载</span>
</span></span><span class=line><span class=cl>$ pip uninstall gdbgui
</span></span></code></pre></td></tr></table></div></div><ul><li>运行gdbgui</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gdbgui -g arm-multiarch
</span></span></code></pre></td></tr></table></div></div><p><figure><img loading=lazy src=/read_linux/picture/image-20230312105941779.png srcset="/read_linux/picture/image-20230312105941779.png, /read_linux/picture/image-20230312105941779.png 1.5x, /read_linux/picture/image-20230312105941779.png 2x" alt=image-20230312105941779 title=image-20230312105941779 height=625 width=1366></figure></p><h2 id=系统构建 class=headerLink><a href=#%e7%b3%bb%e7%bb%9f%e6%9e%84%e5%bb%ba class=header-mark></a>2 系统构建</h2><p>镜像文件的整体过程</p><p><figure><img loading=lazy src=/read_linux/picture/image-20230401145402912.png srcset="/read_linux/picture/image-20230401145402912.png, /read_linux/picture/image-20230401145402912.png 1.5x, /read_linux/picture/image-20230401145402912.png 2x" alt=image-20230401145402912 title=image-20230401145402912 height=325 width=669></figure></p><p><figure><img loading=lazy src=/read_linux/picture/image-20230401153013219.png srcset="/read_linux/picture/image-20230401153013219.png, /read_linux/picture/image-20230401153013219.png 1.5x, /read_linux/picture/image-20230401153013219.png 2x" alt=image-20230401153013219 title=image-20230401153013219 height=368 width=592></figure></p><ul><li>构建<strong>vmlinux</strong>,objcopy生成vmlinux.bin,然后将其压缩为vmlinux.bin.gz</li><li>添加操作,生成<strong>vmlinux.bin</strong></li><li>构造<strong>setup.bin</strong></li><li>将setup.bin与vmlinux.bin进行合成,生成bzImage</li></ul><h3 id=vmlinux生成过程 class=headerLink><a href=#vmlinux%e7%94%9f%e6%88%90%e8%bf%87%e7%a8%8b class=header-mark></a>2.1 vmlinux生成过程</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># x86_64架构链接过程</span>
</span></span><span class=line><span class=cl>ld -m elf_x86_64 --no-ld-generated-unwind-info  -pie  --no-dynamic-linker --orphan-handling<span class=o>=</span>error -z noexecstack --no-warn-rwx-segments
</span></span><span class=line><span class=cl>-T arch/x86/boot/compressed/vmlinux.lds
</span></span><span class=line><span class=cl>	arch/x86/boot/compressed/kernel_info.o arch/x86/boot/compressed/head_64.o 				arch/x86/boot/compressed/misc.o arch/x86/boot/compressed/string.o 						arch/x86/boot/compressed/cmdline.o arch/x86/boot/compressed/error.o           			arch/x86/boot/compressed/piggy.o arch/x86/boot/compressed/cpuflags.o    				arch/x86/boot/compressed/early_serial_console.o arch/x86/boot/compressed/kaslr.o arch/x86/boot/compressed/ident_map_64.o arch/x86/boot/compressed/idt_64.o arch/x86/boot/compressed/idt_handlers_64.o arch/x86/boot/compressed/pgtable_64.o arch/x86/boot/compressed/acpi.o arch/x86/boot/compressed/efi.o arch/x86/boot/compressed/efi_mixed.o drivers/firmware/efi/libstub/lib.a
</span></span><span class=line><span class=cl>	-o arch/x86/boot/compressed/vmlinux
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># arm32链接过程</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=vmlinuxbin生成过程 class=headerLink><a href=#vmlinuxbin%e7%94%9f%e6%88%90%e8%bf%87%e7%a8%8b class=header-mark></a>2.2 vmlinux.bin生成过程</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>objcopy  -O binary -R .note -R .comment -S arch/x86/boot/compressed/vmlinux arch/x86/boot/vmlinux.bin
</span></span></code></pre></td></tr></table></div></div><h3 id=headero class=headerLink><a href=#headero class=header-mark></a>2.3 header.o</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gcc -Wp,-MMD,arch/x86/boot/.header.o.d -nostdinc -I./arch/x86/include -I./arch/x86/include/generated  -I./include -I./arch/x86/include/uapi -I./arch/x86/include/generated/uapi -I./include/uapi -I./include/generated/uapi -include ./include/linux/compiler-version.h -include ./include/linux/kconfig.h -D__KERNEL__ -Werror -fmacro-prefix-map<span class=o>=</span>./<span class=o>=</span> -m16 -g -Os -DDISABLE_BRANCH_PROFILING -D__DISABLE_EXPORTS -Wall -Wstrict-prototypes -march<span class=o>=</span>i386 -mregparm<span class=o>=</span><span class=m>3</span> -fno-strict-aliasing -fomit-frame-pointer -fno-pic -mno-mmx -mno-sse -fcf-protection<span class=o>=</span>none -ffreestanding -fno-stack-protector -Wno-address-of-packed-member -mpreferred-stack-boundary<span class=o>=</span><span class=m>2</span> -D_SETUP -D__ASSEMBLY__ -DSVGA_MODE<span class=o>=</span>NORMAL_VGA -I./arch/x86/boot    -c -o arch/x86/boot/header.o arch/x86/boot/header.S
</span></span></code></pre></td></tr></table></div></div><h3 id=setupbin生成过程 class=headerLink><a href=#setupbin%e7%94%9f%e6%88%90%e8%bf%87%e7%a8%8b class=header-mark></a>2.4 setup.bin生成过程</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ld -m elf_x86_64 -z noexecstack --no-warn-rwx-segments  -m elf_i386 -z noexecstack -T arch/x86/boot/setup.ld arch/x86/boot/a20.o arch/x86/boot/bioscall.o arch/x86/boot/cmdline.o arch/x86/boot/copy.o arch/x86/boot/cpu.o arch/x86/boot/cpuflags.o arch/x86/boot/cpucheck.o arch/x86/boot/early_serial_console.o arch/x86/boot/edd.o arch/x86/boot/header.o arch/x86/boot/main.o arch/x86/boot/memory.o arch/x86/boot/pm.o arch/x86/boot/pmjump.o arch/x86/boot/printf.o arch/x86/boot/regs.o arch/x86/boot/string.o arch/x86/boot/tty.o arch/x86/boot/video.o arch/x86/boot/video-mode.o arch/x86/boot/version.o arch/x86/boot/video-vga.o arch/x86/boot/video-vesa.o arch/x86/boot/video-bios.o -o arch/x86/boot/setup.elf
</span></span><span class=line><span class=cl>objcopy  -O binary arch/x86/boot/setup.elf arch/x86/boot/setup.bin
</span></span></code></pre></td></tr></table></div></div><h3 id=最后生成 class=headerLink><a href=#%e6%9c%80%e5%90%8e%e7%94%9f%e6%88%90 class=header-mark></a>2.5 最后生成</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>arch/x86/boot/tools/build arch/x86/boot/setup.bin arch/x86/boot/vmlinux.bin arch/x86/boot/zoffset.h arch/x86/boot/bzImag
</span></span></code></pre></td></tr></table></div></div><h2 id=根文件系统 class=headerLink><a href=#%e6%a0%b9%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f class=header-mark></a>3 根文件系统</h2><p>linux系统在启动之后需要加载根文件系统</p><p><figure><img loading=lazy src=/read_linux/picture/image-20230401153524962.png srcset="/read_linux/picture/image-20230401153524962.png, /read_linux/picture/image-20230401153524962.png 1.5x, /read_linux/picture/image-20230401153524962.png 2x" alt=image-20230401153524962 title=image-20230401153524962 height=262 width=687></figure></p><p><figure><img loading=lazy src=/read_linux/picture/image-20230401153542375.png srcset="/read_linux/picture/image-20230401153542375.png, /read_linux/picture/image-20230401153542375.png 1.5x, /read_linux/picture/image-20230401153542375.png 2x" alt=image-20230401153542375 title=image-20230401153542375 height=192 width=669></figure></p><h3 id=编译busybox class=headerLink><a href=#%e7%bc%96%e8%af%91busybox class=header-mark></a>3.1 编译busybox</h3><h3 id=安装c库 class=headerLink><a href=#%e5%ae%89%e8%a3%85c%e5%ba%93 class=header-mark></a>3.2 安装C库</h3><p>从交叉编译器中拷贝即可</p><h2 id=initramfs class=headerLink><a href=#initramfs class=header-mark></a>4 initramfs</h2><h3 id=hello-initramfs class=headerLink><a href=#hello-initramfs class=header-mark></a>4.1 Hello initramfs</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Hello initramfs</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行构建</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gcc -static -o init init.c
</span></span><span class=line><span class=cl><span class=nb>echo</span> init <span class=p>|</span> cpio -o --format<span class=o>=</span>newc &gt; initramfs
</span></span></code></pre></td></tr></table></div></div><p>启动测试</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>qemu-system-x86_64 -kernel linux/arch/x86_64/boot/bzImage -initrd initramfs -append &#34;console=ttyS0 rdinit=init&#34; -nographic
</span></span></code></pre></td></tr></table></div></div><p>然后就可以发现打印的数据</p><p><figure><img loading=lazy src=/read_linux/picture/image-20230401191307654.png srcset="/read_linux/picture/image-20230401191307654.png, /read_linux/picture/image-20230401191307654.png 1.5x, /read_linux/picture/image-20230401191307654.png 2x" alt=image-20230401191307654 title=image-20230401191307654 height=562 width=933></figure></p><h2 id=启动分析 class=headerLink><a href=#%e5%90%af%e5%8a%a8%e5%88%86%e6%9e%90 class=header-mark></a>5 启动分析</h2><p>一般情况下，我们都会讲断点打在<code>start_kernel</code>上,但是在进入C语言之前会存在一段汇编代码;</p><p>入口地址,我们可以通过链接脚本分析得到</p><p><a href=https://elixir.bootlin.com/linux/v4.0/source/include/asm-generic/vmlinux.lds.h target=_blank rel="noopener noreferrer">链接头文件</a>,那么真正的链接文件在**[arch/arm/kernel/vmlinux.lds]**,但是这个文件是生成的;</p><p>这个链接脚本用来描述vmlinux的生成</p><p><figure><img loading=lazy src=/read_linux/picture/image-20230401201824826.png srcset="/read_linux/picture/image-20230401201824826.png, /read_linux/picture/image-20230401201824826.png 1.5x, /read_linux/picture/image-20230401201824826.png 2x" alt=image-20230401201824826 title=image-20230401201824826 height=373 width=636></figure></p><p>但是aarch64入口地址就是</p><p><figure><img loading=lazy src=/read_linux/picture/image-20230401202647492.png srcset="/read_linux/picture/image-20230401202647492.png, /read_linux/picture/image-20230401202647492.png 1.5x, /read_linux/picture/image-20230401202647492.png 2x" alt=image-20230401202647492 title=image-20230401202647492 height=339 width=701></figure></p><pre class=mermaid>graph LR

stext --> __mmap_switched

__mmap_switched --> start_kernel
</pre><h3 id=启动前夕 class=headerLink><a href=#%e5%90%af%e5%8a%a8%e5%89%8d%e5%a4%95 class=header-mark></a>5.1 启动前夕</h3><p><strong>启动前夕(ARM32)</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>__mmap_switched:
</span></span><span class=line><span class=cl>	adr	r3, __mmap_switched_data
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	ldmia	r3!, {r4, r5, r6, r7}
</span></span><span class=line><span class=cl>	cmp	r4, r5				@ Copy data segment if needed
</span></span><span class=line><span class=cl>1:	cmpne	r5, r6
</span></span><span class=line><span class=cl>	ldrne	fp, [r4], #4
</span></span><span class=line><span class=cl>	strne	fp, [r5], #4
</span></span><span class=line><span class=cl>	bne	1b
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	mov	fp, #0				@ Clear BSS (and zero fp)
</span></span><span class=line><span class=cl>1:	cmp	r6, r7
</span></span><span class=line><span class=cl>	strcc	fp, [r6],#4
</span></span><span class=line><span class=cl>	bcc	1b
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> ARM(	ldmia	r3, {r4, r5, r6, r7, sp})
</span></span><span class=line><span class=cl> THUMB(	ldmia	r3, {r4, r5, r6, r7}	)
</span></span><span class=line><span class=cl> THUMB(	ldr	sp, [r3, #16]		)
</span></span><span class=line><span class=cl>	str	r9, [r4]			@ Save processor ID
</span></span><span class=line><span class=cl>	str	r1, [r5]			@ Save machine type
</span></span><span class=line><span class=cl>	str	r2, [r6]			@ Save atags pointer
</span></span><span class=line><span class=cl>	cmp	r7, #0
</span></span><span class=line><span class=cl>	strne	r0, [r7]			@ Save control register values
</span></span><span class=line><span class=cl>	b	start_kernel
</span></span><span class=line><span class=cl>ENDPROC(__mmap_switched)
</span></span></code></pre></td></tr></table></div></div><p><strong>启动前夕(ARM64)</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>__mmap_switched:
</span></span><span class=line><span class=cl>	adr	x3, __switch_data + 8
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	ldp	x6, x7, [x3], #16
</span></span><span class=line><span class=cl>1:	cmp	x6, x7
</span></span><span class=line><span class=cl>	b.hs	2f
</span></span><span class=line><span class=cl>	str	xzr, [x6], #8			// Clear BSS
</span></span><span class=line><span class=cl>	b	1b
</span></span><span class=line><span class=cl>2:
</span></span><span class=line><span class=cl>	ldp	x4, x5, [x3], #16
</span></span><span class=line><span class=cl>	ldr	x6, [x3], #8
</span></span><span class=line><span class=cl>	ldr	x16, [x3]
</span></span><span class=line><span class=cl>	mov	sp, x16
</span></span><span class=line><span class=cl>	str	x22, [x4]			// Save processor ID
</span></span><span class=line><span class=cl>	str	x21, [x5]			// Save FDT pointer
</span></span><span class=line><span class=cl>	str	x24, [x6]			// Save PHYS_OFFSET
</span></span><span class=line><span class=cl>	mov	x29, #0
</span></span><span class=line><span class=cl>	b	start_kernel
</span></span><span class=line><span class=cl>ENDPROC(__mmap_switched)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	.align	3
</span></span><span class=line><span class=cl>	.type	__switch_data, %object
</span></span><span class=line><span class=cl>__switch_data:
</span></span><span class=line><span class=cl>	.quad	__mmap_switched
</span></span><span class=line><span class=cl>	.quad	__bss_start			// x6
</span></span><span class=line><span class=cl>	.quad	__bss_stop			// x7
</span></span><span class=line><span class=cl>	.quad	processor_id			// x4
</span></span><span class=line><span class=cl>	.quad	__fdt_pointer			// x5
</span></span><span class=line><span class=cl>	.quad	memstart_addr			// x6
</span></span><span class=line><span class=cl>	.quad	init_thread_union + THREAD_START_SP // sp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ENTRY(stext)
</span></span><span class=line><span class=cl>	mov	x21, x0				// x21=FDT
</span></span><span class=line><span class=cl>	bl	el2_setup			// Drop to EL1, w20=cpu_boot_mode
</span></span><span class=line><span class=cl>	bl	__calc_phys_offset		// x24=PHYS_OFFSET, x28=PHYS_OFFSET-PAGE_OFFSET
</span></span><span class=line><span class=cl>	bl	set_cpu_boot_mode_flag
</span></span><span class=line><span class=cl>	mrs	x22, midr_el1			// x22=cpuid
</span></span><span class=line><span class=cl>	mov	x0, x22
</span></span><span class=line><span class=cl>	bl	lookup_processor_type
</span></span><span class=line><span class=cl>	mov	x23, x0				// x23=current cpu_table
</span></span><span class=line><span class=cl>	/*
</span></span><span class=line><span class=cl>	 * __error_p may end up out of range for cbz if text areas are
</span></span><span class=line><span class=cl>	 * aligned up to section sizes.
</span></span><span class=line><span class=cl>	 */
</span></span><span class=line><span class=cl>	cbnz	x23, 1f				// invalid processor (x23=0)?
</span></span><span class=line><span class=cl>	b	__error_p
</span></span><span class=line><span class=cl>1:
</span></span><span class=line><span class=cl>	bl	__vet_fdt
</span></span><span class=line><span class=cl>	bl	__create_page_tables		// x25=TTBR0, x26=TTBR1
</span></span><span class=line><span class=cl>	/*
</span></span><span class=line><span class=cl>	 * The following calls CPU specific code in a position independent
</span></span><span class=line><span class=cl>	 * manner. See arch/arm64/mm/proc.S for details. x23 = base of
</span></span><span class=line><span class=cl>	 * cpu_info structure selected by lookup_processor_type above.
</span></span><span class=line><span class=cl>	 * On return, the CPU will be ready for the MMU to be turned on and
</span></span><span class=line><span class=cl>	 * the TCR will have been set.
</span></span><span class=line><span class=cl>	 */
</span></span><span class=line><span class=cl>	ldr	x27, __switch_data		// address to jump to after
</span></span><span class=line><span class=cl>						// MMU has been enabled
</span></span><span class=line><span class=cl>	adrp	lr, __enable_mmu		// return (PIC) address
</span></span><span class=line><span class=cl>	add	lr, lr, #:lo12:__enable_mmu
</span></span><span class=line><span class=cl>	ldr	x12, [x23, #CPU_INFO_SETUP]
</span></span><span class=line><span class=cl>	add	x12, x12, x28			// __virt_to_phys
</span></span><span class=line><span class=cl>	br	x12				// initialise processor
</span></span><span class=line><span class=cl>ENDPROC(stext)
</span></span></code></pre></td></tr></table></div></div><p>上面的汇编函数都是由<a href=https://elixir.bootlin.com/linux/v4.0/source/arch/arm/boot/compressed/head.S target=_blank rel="noopener noreferrer">head.s</a>跳入继续向下分析,谁开启了汇编,如何执行到这个函数<strong>vmlinux.lds</strong>决定，分析实现;</p><p>需要分析bootloader的实现;</p><p>下面我们开始分析</p><p><figure><img loading=lazy src=/read_linux/picture/image-20230212185559643.png srcset="/read_linux/picture/image-20230212185559643.png, /read_linux/picture/image-20230212185559643.png 1.5x, /read_linux/picture/image-20230212185559643.png 2x" alt=image-20230212185559643 title=image-20230212185559643 height=433 width=1321></figure></p><h3 id=start_kernel class=headerLink><a href=#start_kernel class=header-mark></a>5.2 start_kernel</h3><p>进入内核中第一个C语言启动函数;<a href=https://elixir.bootlin.com/linux/v4.0/source/init/main.c#L489 target=_blank rel="noopener noreferrer">源码位置</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>asmlinkage</span> <span class=n>__visible</span> <span class=kt>void</span> <span class=n>__init</span> <span class=nf>start_kernel</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>command_line</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>after_dashes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 死锁检测
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>lockdep_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置启动任务的结束磨数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>set_task_stack_end_magic</span><span class=p>(</span><span class=o>&amp;</span><span class=n>init_task</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置smp id
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>smp_setup_processor_id</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// debug
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>debug_objects_early_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 堆栈保护机制
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>boot_init_stack_canary</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// cgroup初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>cgroup_init_early</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// irq中断停止，设置标志位
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>local_irq_disable</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>early_boot_irqs_disabled</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 激活启动CPU
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>boot_cpu_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 单独章节分析
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>page_address_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>pr_notice</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=n>linux_banner</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置架构
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>setup_arch</span><span class=p>(</span><span class=o>&amp;</span><span class=n>command_line</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>mm_init_cpumask</span><span class=p>(</span><span class=o>&amp;</span><span class=n>init_mm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>setup_command_line</span><span class=p>(</span><span class=n>command_line</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>setup_nr_cpu_ids</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>setup_per_cpu_areas</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>smp_prepare_boot_cpu</span><span class=p>();</span>	<span class=cm>/* arch-specific boot-cpu hooks */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>build_all_zonelists</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>page_alloc_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>pr_notice</span><span class=p>(</span><span class=s>&#34;Kernel command line: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>boot_command_line</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>parse_early_param</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>after_dashes</span> <span class=o>=</span> <span class=nf>parse_args</span><span class=p>(</span><span class=s>&#34;Booting kernel&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				  <span class=n>static_command_line</span><span class=p>,</span> <span class=n>__start___param</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				  <span class=n>__stop___param</span> <span class=o>-</span> <span class=n>__start___param</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				  <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>unknown_bootoption</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>IS_ERR_OR_NULL</span><span class=p>(</span><span class=n>after_dashes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nf>parse_args</span><span class=p>(</span><span class=s>&#34;Setting init args&#34;</span><span class=p>,</span> <span class=n>after_dashes</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			   <span class=n>set_init_arg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>jump_label_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * These use large bootmem allocations and must precede
</span></span></span><span class=line><span class=cl><span class=cm>	 * kmem_cache_init()
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>setup_log_buf</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>pidhash_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>vfs_caches_init_early</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>sort_main_extable</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>trap_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>mm_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Set up the scheduler prior starting any interrupts (such as the
</span></span></span><span class=line><span class=cl><span class=cm>	 * timer interrupt). Full topology setup happens at smp_init()
</span></span></span><span class=line><span class=cl><span class=cm>	 * time - but meanwhile we still have a functioning scheduler.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>sched_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Disable preemption - early bootup scheduling is extremely
</span></span></span><span class=line><span class=cl><span class=cm>	 * fragile until we cpu_idle() for the first time.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>preempt_disable</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nf>WARN</span><span class=p>(</span><span class=o>!</span><span class=nf>irqs_disabled</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		 <span class=s>&#34;Interrupts were enabled *very* early, fixing it</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nf>local_irq_disable</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>idr_init_cache</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>rcu_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* trace_printk() and trace points may be used after this */</span>
</span></span><span class=line><span class=cl>	<span class=nf>trace_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>context_tracking_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>radix_tree_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* init some links before init_ISA_irqs() */</span>
</span></span><span class=line><span class=cl>	<span class=nf>early_irq_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>init_IRQ</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>tick_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>rcu_init_nohz</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>init_timers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>hrtimers_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>softirq_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>timekeeping_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>time_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>sched_clock_postinit</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>perf_event_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>profile_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>call_function_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>WARN</span><span class=p>(</span><span class=o>!</span><span class=nf>irqs_disabled</span><span class=p>(),</span> <span class=s>&#34;Interrupts were enabled early</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>early_boot_irqs_disabled</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>local_irq_enable</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>kmem_cache_init_late</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * HACK ALERT! This is early. We&#39;re enabling the console before
</span></span></span><span class=line><span class=cl><span class=cm>	 * we&#39;ve done PCI setups etc, and console_init() must be aware of
</span></span></span><span class=line><span class=cl><span class=cm>	 * this. But we do want output early, in case something goes wrong.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>console_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>panic_later</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>panic</span><span class=p>(</span><span class=s>&#34;Too many boot %s vars at `%s&#39;&#34;</span><span class=p>,</span> <span class=n>panic_later</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		      <span class=n>panic_param</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>lockdep_info</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Need to run this when irqs are enabled, because it wants
</span></span></span><span class=line><span class=cl><span class=cm>	 * to self-test [hard/soft]-irqs on/off lock inversion bugs
</span></span></span><span class=line><span class=cl><span class=cm>	 * too:
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>locking_selftest</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#ifdef CONFIG_BLK_DEV_INITRD
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=k>if</span> <span class=p>(</span><span class=n>initrd_start</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>initrd_below_start_ok</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>	    <span class=nf>page_to_pfn</span><span class=p>(</span><span class=nf>virt_to_page</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>initrd_start</span><span class=p>))</span> <span class=o>&lt;</span> <span class=n>min_low_pfn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>pr_crit</span><span class=p>(</span><span class=s>&#34;initrd overwritten (0x%08lx &lt; 0x%08lx) - disabling it.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		    <span class=nf>page_to_pfn</span><span class=p>(</span><span class=nf>virt_to_page</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>initrd_start</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		    <span class=n>min_low_pfn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>initrd_start</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=nf>page_ext_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>debug_objects_mem_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>kmemleak_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>setup_per_cpu_pageset</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>numa_policy_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>late_time_init</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>late_time_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>sched_clock_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>calibrate_delay</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>pidmap_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>anon_vma_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>acpi_early_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef CONFIG_X86
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=k>if</span> <span class=p>(</span><span class=nf>efi_enabled</span><span class=p>(</span><span class=n>EFI_RUNTIME_SERVICES</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nf>efi_enter_virtual_mode</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp>#ifdef CONFIG_X86_ESPFIX64
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=cm>/* Should be run before the first non-init thread is created */</span>
</span></span><span class=line><span class=cl>	<span class=nf>init_espfix_bsp</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=nf>thread_info_cache_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>cred_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>fork_init</span><span class=p>(</span><span class=n>totalram_pages</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>proc_caches_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>buffer_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>key_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>security_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>dbg_late_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>vfs_caches_init</span><span class=p>(</span><span class=n>totalram_pages</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>signals_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* rootfs populating might need page-writeback */</span>
</span></span><span class=line><span class=cl>	<span class=nf>page_writeback_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>proc_root_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>nsfs_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>cgroup_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>cpuset_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>taskstats_init_early</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>delayacct_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>check_bugs</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>sfi_init_late</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nf>efi_enabled</span><span class=p>(</span><span class=n>EFI_RUNTIME_SERVICES</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>efi_late_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=nf>efi_free_boot_services</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>ftrace_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Do the rest non-__init&#39;ed, we&#39;re now alive */</span>
</span></span><span class=line><span class=cl>	<span class=nf>rest_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>但是谁调用了此函数呢?</p><h3 id=reset_init class=headerLink><a href=#reset_init class=header-mark></a>5.3 reset_init</h3><p>这个是系统调用的最后一个函数,调用结束后不会返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=n>noinline</span> <span class=kt>void</span> <span class=n>__init_refok</span> <span class=nf>rest_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>rcu_scheduler_starting</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * We need to spawn init first so that it obtains pid 1, however
</span></span></span><span class=line><span class=cl><span class=cm>	 * the init task will end up wanting to create kthreads, which, if
</span></span></span><span class=line><span class=cl><span class=cm>	 * we schedule it before we create kthreadd, will OOPS.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>kernel_thread</span><span class=p>(</span><span class=n>kernel_init</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=n>CLONE_FS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>numa_default_policy</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>pid</span> <span class=o>=</span> <span class=nf>kernel_thread</span><span class=p>(</span><span class=n>kthreadd</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=n>CLONE_FS</span> <span class=o>|</span> <span class=n>CLONE_FILES</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>rcu_read_lock</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>kthreadd_task</span> <span class=o>=</span> <span class=nf>find_task_by_pid_ns</span><span class=p>(</span><span class=n>pid</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>init_pid_ns</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>rcu_read_unlock</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>complete</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kthreadd_done</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * The boot idle thread must execute schedule()
</span></span></span><span class=line><span class=cl><span class=cm>	 * at least once to get things moving:
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>init_idle_bootup_task</span><span class=p>(</span><span class=n>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>schedule_preempt_disabled</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Call into cpu_idle with preempt disabled */</span>
</span></span><span class=line><span class=cl>	<span class=nf>cpu_startup_entry</span><span class=p>(</span><span class=n>CPUHP_ONLINE</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=设置init任务堆栈 class=headerLink><a href=#%e8%ae%be%e7%bd%aeinit%e4%bb%bb%e5%8a%a1%e5%a0%86%e6%a0%88 class=header-mark></a>5.4 设置<code>init</code>任务堆栈</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>set_task_stack_end_magic</span><span class=p>(</span><span class=o>&amp;</span><span class=n>init_task</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>set_task_stack_end_magic</span><span class=p>(</span><span class=k>struct</span> <span class=n>task_struct</span> <span class=o>*</span><span class=n>tsk</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=n>stackend</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>stackend</span> <span class=o>=</span> <span class=nf>end_of_stack</span><span class=p>(</span><span class=n>tsk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>stackend</span> <span class=o>=</span> <span class=n>STACK_END_MAGIC</span><span class=p>;</span>	<span class=cm>/* for overflow detection */</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><figure><img loading=lazy src=/read_linux/picture/image-20230212190355701.png srcset="/read_linux/picture/image-20230212190355701.png, /read_linux/picture/image-20230212190355701.png 1.5x, /read_linux/picture/image-20230212190355701.png 2x" alt=image-20230212190355701 title=image-20230212190355701 height=134 width=1264></figure></p><p>此处可以得知:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=nf>end_of_stack</span><span class=p>(</span><span class=k>struct</span> <span class=n>task_struct</span> <span class=o>*</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef CONFIG_STACK_GROWSUP
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=k>return</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=nf>task_thread_info</span><span class=p>(</span><span class=n>p</span><span class=p>)</span> <span class=o>+</span> <span class=n>THREAD_SIZE</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=k>return</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=nf>task_thread_info</span><span class=p>(</span><span class=n>p</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=设置smp的cpu-id class=headerLink><a href=#%e8%ae%be%e7%bd%aesmp%e7%9a%84cpu-id class=header-mark></a>5.5 设置smp的CPU ID</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=n>nr_cpu_ids</span> <span class=n>__read_mostly</span> <span class=o>=</span> <span class=n>NR_CPUS</span><span class=p>;</span>		<span class=c1>// 此参数通过配置文件得到
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>EXPORT_SYMBOL</span><span class=p>(</span><span class=n>nr_cpu_ids</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>u32</span> <span class=n>__cpu_logical_map</span><span class=p>[</span><span class=n>NR_CPUS</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=p>[</span><span class=mi>0</span> <span class=p>...</span> <span class=n>NR_CPUS</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>MPIDR_INVALID</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=cp>#define cpu_logical_map(cpu)	__cpu_logical_map[cpu]
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// 1. 设置cpu_logical_map
</span></span></span><span class=line><span class=cl><span class=c1>// 2. 设置线程ID
</span></span></span><span class=line><span class=cl><span class=c1>// 3. 打印日志
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>__init</span> <span class=nf>smp_setup_processor_id</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>u32</span> <span class=n>mpidr</span> <span class=o>=</span> <span class=nf>is_smp</span><span class=p>()</span> <span class=o>?</span> <span class=nf>read_cpuid_mpidr</span><span class=p>()</span> <span class=o>&amp;</span> <span class=nl>MPIDR_HWID_BITMASK</span> <span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>u32</span> <span class=n>cpu</span> <span class=o>=</span> <span class=nf>MPIDR_AFFINITY_LEVEL</span><span class=p>(</span><span class=n>mpidr</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>cpu_logical_map</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>=</span> <span class=n>cpu</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>nr_cpu_ids</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>cpu_logical_map</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=o>=</span> <span class=n>i</span> <span class=o>==</span> <span class=n>cpu</span> <span class=o>?</span> <span class=mi>0</span> <span class=o>:</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * clear __my_cpu_offset on boot CPU to avoid hang caused by
</span></span></span><span class=line><span class=cl><span class=cm>	 * using percpu variable early, for example, lockdep will
</span></span></span><span class=line><span class=cl><span class=cm>	 * access percpu variable inside lock_release
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>set_my_cpu_offset</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>pr_info</span><span class=p>(</span><span class=s>&#34;Booting Linux on physical CPU 0x%x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>mpidr</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 设置线程ID
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=nf>set_my_cpu_offset</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>off</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Set TPIDRPRW */</span>
</span></span><span class=line><span class=cl>    <span class=c1>// off=0x0
</span></span></span><span class=line><span class=cl><span class=c1></span> 	<span class=k>asm</span> <span class=k>volatile</span><span class=p>(</span><span class=s>&#34;mcr p15, 0, %0, c13, c0, 4&#34;</span> <span class=o>:</span> <span class=o>:</span> <span class=s>&#34;r&#34;</span> <span class=p>(</span><span class=n>off</span><span class=p>)</span> <span class=o>:</span> <span class=s>&#34;memory&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=激活启动cpu class=headerLink><a href=#%e6%bf%80%e6%b4%bb%e5%90%af%e5%8a%a8cpu class=header-mark></a>5.6 激活启动CPU</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=n>__init</span> <span class=nf>boot_cpu_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>cpu</span> <span class=o>=</span> <span class=nf>smp_processor_id</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Mark the boot cpu &#34;present&#34;, &#34;online&#34; etc for SMP and UP case */</span>
</span></span><span class=line><span class=cl>	<span class=nf>set_cpu_online</span><span class=p>(</span><span class=n>cpu</span><span class=p>,</span> <span class=nb>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>set_cpu_active</span><span class=p>(</span><span class=n>cpu</span><span class=p>,</span> <span class=nb>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>set_cpu_present</span><span class=p>(</span><span class=n>cpu</span><span class=p>,</span> <span class=nb>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>set_cpu_possible</span><span class=p>(</span><span class=n>cpu</span><span class=p>,</span> <span class=nb>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=设置架构 class=headerLink><a href=#%e8%ae%be%e7%bd%ae%e6%9e%b6%e6%9e%84 class=header-mark></a>5.7 设置架构</h3><p>读取配置文件(设置树),设置内存信息</p><p>在设备树一章节中会详细分析</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=n>__init</span> <span class=nf>setup_arch</span><span class=p>(</span><span class=kt>char</span> <span class=o>**</span><span class=n>cmdline_p</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 机器描述符
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>const</span> <span class=k>struct</span> <span class=n>machine_desc</span> <span class=o>*</span><span class=n>mdesc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置处理器相关信息
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>setup_processor</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 读取设备树信息
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>mdesc</span> <span class=o>=</span> <span class=nf>setup_machine_fdt</span><span class=p>(</span><span class=n>__atags_pointer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mdesc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>mdesc</span> <span class=o>=</span> <span class=nf>setup_machine_tags</span><span class=p>(</span><span class=n>__atags_pointer</span><span class=p>,</span> <span class=n>__machine_arch_type</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置到全局变量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>machine_desc</span> <span class=o>=</span> <span class=n>mdesc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>machine_name</span> <span class=o>=</span> <span class=n>mdesc</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>dump_stack_set_arch_desc</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=n>mdesc</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>mdesc</span><span class=o>-&gt;</span><span class=n>reboot_mode</span> <span class=o>!=</span> <span class=n>REBOOT_HARD</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>reboot_mode</span> <span class=o>=</span> <span class=n>mdesc</span><span class=o>-&gt;</span><span class=n>reboot_mode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置init任务
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>init_mm</span><span class=p>.</span><span class=n>start_code</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=n>_text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>init_mm</span><span class=p>.</span><span class=n>end_code</span>   <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=n>_etext</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>init_mm</span><span class=p>.</span><span class=n>end_data</span>   <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=n>_edata</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>init_mm</span><span class=p>.</span><span class=n>brk</span>	   	   <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=n>_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* populate cmd_line too for later use, preserving boot_command_line */</span>
</span></span><span class=line><span class=cl>	<span class=nf>strlcpy</span><span class=p>(</span><span class=n>cmd_line</span><span class=p>,</span> <span class=n>boot_command_line</span><span class=p>,</span> <span class=n>COMMAND_LINE_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>cmdline_p</span> <span class=o>=</span> <span class=n>cmd_line</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>parse_early_param</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 读取设备树
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>early_paging_init</span><span class=p>(</span><span class=n>mdesc</span><span class=p>,</span> <span class=nf>lookup_processor_type</span><span class=p>(</span><span class=nf>read_cpuid_id</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>	<span class=nf>setup_dma_zone</span><span class=p>(</span><span class=n>mdesc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>sanity_check_meminfo</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>arm_memblock_init</span><span class=p>(</span><span class=n>mdesc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>paging_init</span><span class=p>(</span><span class=n>mdesc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>request_standard_resources</span><span class=p>(</span><span class=n>mdesc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>mdesc</span><span class=o>-&gt;</span><span class=n>restart</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>arm_pm_restart</span> <span class=o>=</span> <span class=n>mdesc</span><span class=o>-&gt;</span><span class=n>restart</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>unflatten_device_tree</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>arm_dt_init_cpu_maps</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>psci_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef CONFIG_SMP
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=k>if</span> <span class=p>(</span><span class=nf>is_smp</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mdesc</span><span class=o>-&gt;</span><span class=n>smp_init</span> <span class=o>||</span> <span class=o>!</span><span class=n>mdesc</span><span class=o>-&gt;</span><span class=nf>smp_init</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=nf>psci_smp_available</span><span class=p>())</span>
</span></span><span class=line><span class=cl>				<span class=nf>smp_set_ops</span><span class=p>(</span><span class=o>&amp;</span><span class=n>psci_smp_ops</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>mdesc</span><span class=o>-&gt;</span><span class=n>smp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nf>smp_set_ops</span><span class=p>(</span><span class=n>mdesc</span><span class=o>-&gt;</span><span class=n>smp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nf>smp_init_cpus</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=nf>smp_build_mpidr_hash</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>is_smp</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=nf>hyp_mode_check</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>reserve_crashkernel</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#ifdef CONFIG_MULTI_IRQ_HANDLER
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=n>handle_arch_irq</span> <span class=o>=</span> <span class=n>mdesc</span><span class=o>-&gt;</span><span class=n>handle_irq</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef CONFIG_VT
</span></span></span><span class=line><span class=cl><span class=cp>#if defined(CONFIG_VGA_CONSOLE)
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=n>conswitchp</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>vga_con</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#elif defined(CONFIG_DUMMY_CONSOLE)
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=n>conswitchp</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>dummy_con</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>mdesc</span><span class=o>-&gt;</span><span class=n>init_early</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>mdesc</span><span class=o>-&gt;</span><span class=nf>init_early</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=mm_init_cpumask class=headerLink><a href=#mm_init_cpumask class=header-mark></a>5.8 mm_init_cpumask</h3><p>清理内存管理系统的<code>init_mm->cpu_vm_mask_var</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=nf>mm_init_cpumask</span><span class=p>(</span><span class=k>struct</span> <span class=n>mm_struct</span> <span class=o>*</span><span class=n>mm</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef CONFIG_CPUMASK_OFFSTACK
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=n>mm</span><span class=o>-&gt;</span><span class=n>cpu_vm_mask_var</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>mm</span><span class=o>-&gt;</span><span class=n>cpumask_allocation</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=nf>cpumask_clear</span><span class=p>(</span><span class=n>mm</span><span class=o>-&gt;</span><span class=n>cpu_vm_mask_var</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=设置命令行command_line class=headerLink><a href=#%e8%ae%be%e7%bd%ae%e5%91%bd%e4%bb%a4%e8%a1%8ccommand_line class=header-mark></a>5.9 设置命令行<code>command_line</code></h3><p>申请内存， 保存命令行参数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* Untouched saved command line (eg. for /proc) */</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=n>saved_command_line</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cm>/* Command line for parameter parsing */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>char</span> <span class=o>*</span><span class=n>static_command_line</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cm>/* Command line for per-initcall parameter parsing */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>char</span> <span class=o>*</span><span class=n>initcall_command_line</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=n>__init</span> <span class=nf>setup_command_line</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>command_line</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>saved_command_line</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>		<span class=nf>memblock_virt_alloc</span><span class=p>(</span><span class=nf>strlen</span><span class=p>(</span><span class=n>boot_command_line</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>initcall_command_line</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>		<span class=nf>memblock_virt_alloc</span><span class=p>(</span><span class=nf>strlen</span><span class=p>(</span><span class=n>boot_command_line</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>static_command_line</span> <span class=o>=</span> <span class=nf>memblock_virt_alloc</span><span class=p>(</span><span class=nf>strlen</span><span class=p>(</span><span class=n>command_line</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>strcpy</span><span class=p>(</span><span class=n>saved_command_line</span><span class=p>,</span> <span class=n>boot_command_line</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>strcpy</span><span class=p>(</span><span class=n>static_command_line</span><span class=p>,</span> <span class=n>command_line</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=设置cpu class=headerLink><a href=#%e8%ae%be%e7%bd%aecpu class=header-mark></a>5.10 设置CPU</h3><ol><li><code>setup_nr_cpu_ids</code></li><li><code>setup_per_cpu_areas</code></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* Setup number of possible processor ids */</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>nr_cpu_ids</span> <span class=n>__read_mostly</span> <span class=o>=</span> <span class=n>NR_CPUS</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nf>EXPORT_SYMBOL</span><span class=p>(</span><span class=n>nr_cpu_ids</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* An arch may set nr_cpu_ids earlier if needed, so this would be redundant */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>__init</span> <span class=nf>setup_nr_cpu_ids</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>nr_cpu_ids</span> <span class=o>=</span> <span class=nf>find_last_bit</span><span class=p>(</span><span class=nf>cpumask_bits</span><span class=p>(</span><span class=n>cpu_possible_mask</span><span class=p>),</span><span class=n>NR_CPUS</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=smp_prepare_boot_cpu class=headerLink><a href=#smp_prepare_boot_cpu class=header-mark></a>5.11 smp_prepare_boot_cpu</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=nf>set_my_cpu_offset</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>off</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Set TPIDRPRW */</span>
</span></span><span class=line><span class=cl>	<span class=k>asm</span> <span class=k>volatile</span><span class=p>(</span><span class=s>&#34;mcr p15, 0, %0, c13, c0, 4&#34;</span> <span class=o>:</span> <span class=o>:</span> <span class=s>&#34;r&#34;</span> <span class=p>(</span><span class=n>off</span><span class=p>)</span> <span class=o>:</span> <span class=s>&#34;memory&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>__init</span> <span class=nf>smp_prepare_boot_cpu</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>set_my_cpu_offset</span><span class=p>(</span><span class=nf>per_cpu_offset</span><span class=p>(</span><span class=nf>smp_processor_id</span><span class=p>()));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=build_all_zonelists class=headerLink><a href=#build_all_zonelists class=header-mark></a>5.12 build_all_zonelists</h3><p>启动期间构建zone,</p><p><strong>[build_all_zonelists &ndash;> build_all_zonelists_init]</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> *  zonelist_order:
</span></span></span><span class=line><span class=cl><span class=cm> *  0 = automatic detection of better ordering.
</span></span></span><span class=line><span class=cl><span class=cm> *  1 = order by ([node] distance, -zonetype)
</span></span></span><span class=line><span class=cl><span class=cm> *  2 = order by (-zonetype, [node] distance)
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> *  If not NUMA, ZONELIST_ORDER_ZONE and ZONELIST_ORDER_NODE will create
</span></span></span><span class=line><span class=cl><span class=cm> *  the same zonelist. So only NUMA can configure this param.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#define ZONELIST_ORDER_DEFAULT  0
</span></span></span><span class=line><span class=cl><span class=cp>#define ZONELIST_ORDER_NODE     1
</span></span></span><span class=line><span class=cl><span class=cp>#define ZONELIST_ORDER_ZONE     2
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* zonelist order in the kernel.
</span></span></span><span class=line><span class=cl><span class=cm> * set_zonelist_order() will set this to NODE or ZONE.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>current_zonelist_order</span> <span class=o>=</span> <span class=n>ZONELIST_ORDER_DEFAULT</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>char</span> <span class=n>zonelist_order_name</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>8</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s>&#34;Default&#34;</span><span class=p>,</span> <span class=s>&#34;Node&#34;</span><span class=p>,</span> <span class=s>&#34;Zone&#34;</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>set_zonelist_order</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>current_zonelist_order</span> <span class=o>=</span> <span class=n>ZONELIST_ORDER_ZONE</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>最终调用到<code>build_all_zonelists_init</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=n>noinline</span> <span class=kt>void</span> <span class=n>__init</span> <span class=nf>build_all_zonelists_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>__build_all_zonelists</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>mminit_verify_zonelist</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>cpuset_init_current_mems_allowed</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=page_alloc_init class=headerLink><a href=#page_alloc_init class=header-mark></a>5.13 page_alloc_init</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=n>__init</span> <span class=nf>page_alloc_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>hotcpu_notifier</span><span class=p>(</span><span class=n>page_alloc_cpu_notify</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=jump_label_init class=headerLink><a href=#jump_label_init class=header-mark></a>5.14 jump_label_init</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Used to generate warnings if static_key manipulation functions are used
</span></span></span><span class=line><span class=cl><span class=cm> * before jump_label_init is called.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>bool</span> <span class=n>static_key_initialized</span> <span class=n>__read_mostly</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nf>EXPORT_SYMBOL_GPL</span><span class=p>(</span><span class=n>static_key_initialized</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>__always_inline</span> <span class=kt>void</span> <span class=nf>jump_label_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>static_key_initialized</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=setup_log_buf class=headerLink><a href=#setup_log_buf class=header-mark></a>5.15 setup_log_buf</h3><p>设置日志buf</p><h3 id=pidhash_init class=headerLink><a href=#pidhash_init class=header-mark></a>5.16 pidhash_init</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>hlist_head</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>hlist_node</span> <span class=o>*</span><span class=n>first</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>hlist_node</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>hlist_node</span> <span class=o>*</span><span class=n>next</span><span class=p>,</span> <span class=o>**</span><span class=n>pprev</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>hlist_head</span> <span class=o>*</span><span class=n>pid_hash</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>pidhash_shift</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>__init</span> <span class=nf>pidhash_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>pidhash_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>pid_hash</span> <span class=o>=</span> <span class=nf>alloc_large_system_hash</span><span class=p>(</span><span class=s>&#34;PID&#34;</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>pid_hash</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>18</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					   <span class=n>HASH_EARLY</span> <span class=o>|</span> <span class=n>HASH_SMALL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					   <span class=o>&amp;</span><span class=n>pidhash_shift</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					   <span class=mi>0</span><span class=p>,</span> <span class=mi>4096</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>pidhash_size</span> <span class=o>=</span> <span class=mi>1U</span> <span class=o>&lt;&lt;</span> <span class=n>pidhash_shift</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>pidhash_size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>INIT_HLIST_HEAD</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pid_hash</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=vfs_caches_init_early class=headerLink><a href=#vfs_caches_init_early class=header-mark></a>5.17 vfs_caches_init_early</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=n>__init</span> <span class=nf>vfs_caches_init_early</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>dcache_init_early</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>inode_init_early</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=sort_main_extable class=headerLink><a href=#sort_main_extable class=header-mark></a>5.18 sort_main_extable</h3><p><strong>异常修复表</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>exception_table_entry</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>insn</span><span class=p>,</span> <span class=n>fixup</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=k>struct</span> <span class=n>exception_table_entry</span> <span class=n>__start___ex_table</span><span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=k>struct</span> <span class=n>exception_table_entry</span> <span class=n>__stop___ex_table</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>__init</span> <span class=nf>sort_main_extable</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>main_extable_sort_needed</span> <span class=o>&amp;&amp;</span> <span class=n>__stop___ex_table</span> <span class=o>&gt;</span> <span class=n>__start___ex_table</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>pr_notice</span><span class=p>(</span><span class=s>&#34;Sorting __ex_table...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>sort_extable</span><span class=p>(</span><span class=n>__start___ex_table</span><span class=p>,</span> <span class=n>__stop___ex_table</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>cmp_ex</span><span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>a</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=k>struct</span> <span class=n>exception_table_entry</span> <span class=o>*</span><span class=n>x</span> <span class=o>=</span> <span class=n>a</span><span class=p>,</span> <span class=o>*</span><span class=n>y</span> <span class=o>=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* avoid overflow */</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>insn</span> <span class=o>&gt;</span> <span class=n>y</span><span class=o>-&gt;</span><span class=n>insn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>insn</span> <span class=o>&lt;</span> <span class=n>y</span><span class=o>-&gt;</span><span class=n>insn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>sort_extable</span><span class=p>(</span><span class=k>struct</span> <span class=n>exception_table_entry</span> <span class=o>*</span><span class=n>start</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		  <span class=k>struct</span> <span class=n>exception_table_entry</span> <span class=o>*</span><span class=n>finish</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>sort</span><span class=p>(</span><span class=n>start</span><span class=p>,</span> <span class=n>finish</span> <span class=o>-</span> <span class=n>start</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>exception_table_entry</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	     <span class=n>cmp_ex</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>但是这个表定义在什么位置内?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>	<span class=p>.</span> <span class=o>=</span> <span class=nf>ALIGN</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nl>__ex_table</span> <span class=p>:</span> <span class=nf>AT</span><span class=p>(</span><span class=nf>ADDR</span><span class=p>(</span><span class=n>__ex_table</span><span class=p>)</span> <span class=o>-</span> <span class=n>LOAD_OFFSET</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>__start___ex_table</span> <span class=o>=</span> <span class=p>.;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef CONFIG_MMU
</span></span></span><span class=line><span class=cl><span class=cp></span>		<span class=o>*</span><span class=p>(</span><span class=n>__ex_table</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>		<span class=n>__stop___ex_table</span> <span class=o>=</span> <span class=p>.;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在链接脚本中定义,代表着什么呢？如何定义这个表呢？</p><p>大部分都是汇编实现的，当前不进行分析了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># define _ASM_EXTABLE_TYPE(from, to, type)			\
</span></span><span class=line><span class=cl>	.pushsection &#34;__ex_table&#34;,&#34;a&#34; ;					\
</span></span><span class=line><span class=cl>	.balign 4 ;										\
</span></span><span class=line><span class=cl>	.long (from) - . ;								\
</span></span><span class=line><span class=cl>	.long (to) - . ;								\
</span></span><span class=line><span class=cl>	.long type ;									\
</span></span><span class=line><span class=cl>	.popsection
</span></span></code></pre></td></tr></table></div></div><p>如何调用这个<strong>异常修复表</strong>呢?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>fixup_exception</span><span class=p>(</span><span class=k>struct</span> <span class=n>pt_regs</span> <span class=o>*</span><span class=n>regs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=k>struct</span> <span class=n>exception_table_entry</span> <span class=o>*</span><span class=n>fixup</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>fixup</span> <span class=o>=</span> <span class=nf>search_exception_tables</span><span class=p>(</span><span class=nf>instruction_pointer</span><span class=p>(</span><span class=n>regs</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>fixup</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>regs</span><span class=o>-&gt;</span><span class=n>ARM_pc</span> <span class=o>=</span> <span class=n>fixup</span><span class=o>-&gt;</span><span class=n>fixup</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef CONFIG_THUMB2_KERNEL
</span></span></span><span class=line><span class=cl><span class=cp></span>		<span class=cm>/* Clear the IT state to avoid nasty surprises in the fixup */</span>
</span></span><span class=line><span class=cl>		<span class=n>regs</span><span class=o>-&gt;</span><span class=n>ARM_cpsr</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>PSR_IT_MASK</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>fixup</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>调用线路</p><pre class=mermaid>graph LR
fixup_exception --> search_exception_tables --> search_extable --> search_module_extables
</pre><h3 id=trap_init class=headerLink><a href=#trap_init class=header-mark></a>5.19 trap_init</h3><p>中断描述符初始化，但是在arm上初始化好像不是这样进行的</p><p>arm上此选项无效</p><h3 id=mm_init class=headerLink><a href=#mm_init class=header-mark></a>5.20 mm_init</h3><p>内存分配器初始化(单独分析)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=n>__init</span> <span class=nf>mm_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * page_ext requires contiguous pages,
</span></span></span><span class=line><span class=cl><span class=cm>	 * bigger than MAX_ORDER unless SPARSEMEM.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>page_ext_init_flatmem</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>mem_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>kmem_cache_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>percpu_init_late</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>pgtable_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>vmalloc_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=sched_init class=headerLink><a href=#sched_init class=header-mark></a>5.21 sched_init</h3><p>调度器初始化(单独分析)</p><h3 id=idr_init_cache class=headerLink><a href=#idr_init_cache class=header-mark></a>5.22 idr_init_cache</h3><p>整数ID管理机制</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=n>__init</span> <span class=nf>idr_init_cache</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>idr_layer_cache</span> <span class=o>=</span> <span class=nf>kmem_cache_create</span><span class=p>(</span><span class=s>&#34;idr_layer_cache&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>idr_layer</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=n>SLAB_PANIC</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=rcu_init class=headerLink><a href=#rcu_init class=header-mark></a>5.23 rcu_init</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=n>__init</span> <span class=nf>rcu_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>cpu</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>rcu_bootup_announce</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>rcu_init_geometry</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>rcu_init_one</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rcu_bh_state</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rcu_bh_data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>rcu_init_one</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rcu_sched_state</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rcu_sched_data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>__rcu_init_preempt</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>open_softirq</span><span class=p>(</span><span class=n>RCU_SOFTIRQ</span><span class=p>,</span> <span class=n>rcu_process_callbacks</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * We don&#39;t need protection against CPU-hotplug here because
</span></span></span><span class=line><span class=cl><span class=cm>	 * this is called early in boot, before either interrupts
</span></span></span><span class=line><span class=cl><span class=cm>	 * or the scheduler are operational.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>cpu_notifier</span><span class=p>(</span><span class=n>rcu_cpu_notify</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>pm_notifier</span><span class=p>(</span><span class=n>rcu_pm_notify</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>for_each_online_cpu</span><span class=p>(</span><span class=n>cpu</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>rcu_cpu_notify</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=n>CPU_UP_PREPARE</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=kt>long</span><span class=p>)</span><span class=n>cpu</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>rcu_early_boot_tests</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-12-23&nbsp;<a class=git-hash href=https://github.com/mengdemao/github.io.git/commit/1754a59682478981911be0d61138b31fb0f92745 target=_blank title="commit by Meng Demao(mengdemao19951021@163.com) 1754a59682478981911be0d61138b31fb0f92745: 转换文件格式" rel="noopener noreferrer">
<i class="fas fa-hashtag fa-fw"></i>1754a59</a></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-mardown href=/read_linux/index.md target=_blank rel="noopener noreferrer">阅读原始文档</a>
</span><span>|&nbsp;<a class=link-to-source href=https://github.com/mengdemao/github.io/blob/master/content/posts/read_linux/index.md target=_blank rel="noopener noreferrer">查看源代码</a>
</span><span>|&nbsp;<a class=link-to-edit href=https://github.com/mengdemao/github.io/edit/master/content/posts/read_linux/index.md target=_blank rel="noopener noreferrer">编辑此页</a>
</span><span>|&nbsp;<a class=link-to-report href="https://github.com/mengdemao/github.io/issues/new?title=[bug]%20Linux%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB&body=|Field|Value|%0A|-|-|%0A|Title|Linux%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB|%0A|Url|https://mengdemao.github.io/read_linux/|%0A|Filename|https://github.com/mengdemao/github.io/blob/main/exampleSite/content/posts/read_linux/index.md|" target=_blank rel="noopener noreferrer">报告问题</a></span></div><div class=post-info-share></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/linux-kernel/>Linux Kernel</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/nodejs/ class=prev rel=prev title=Nodejs笔记><i class="fas fa-angle-left fa-fw"></i>Nodejs笔记</a>
<a href=/uboot/ class=next rel=next title=Uboot>Uboot<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.123.8">Hugo</a> 强力驱动&nbsp;|&nbsp;托管在 <a title="Github Pages" href=https://docs.github.com/en/pages/ target=_blank rel="noopener noreffer">GitHub Pages</a> 上&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/mengdemao target=_blank rel="noopener noreferrer">mengdemao</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href=http://www.miitbeian.gov.cn/>鲁ICP备2023050410号</a></span></div><div class=footer-line></div><div class=footer-line></div></div><script>"serviceWorker"in navigator&&(navigator.serviceWorker.register("/sw.min.js",{scope:"/"}).then(function(){}),navigator.serviceWorker.ready.then(function(){}))</script></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div id=cookieconsent-container></div><div class=assets><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.cd0d0b6e50ff01ff2f3a9a70d7cfb66a7c6cb9acf7a566325568be6d3bd31fc4.css integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q="><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:300},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"Hugo-DoIt/utterances-comments"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"desktop-header-typeit":"编程日志","mobile-header-typeit":"编程日志"},search:{algoliaAppID:"PQZTCYTP3M",algoliaIndex:"zh_cn_meng",algoliaSearchKey:"67a3d5929b94f3dc005abb63778b8928",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},table:{sort:!0},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:-1,speed:100}}</script><script type=text/javascript src=/lib/tablesort/tablesort.min.92de6dec051677787aed63503575b2f9be73f21f2745574e59647bc139a92d40.js integrity="sha256-kt5t7AUWd3h67WNQNXWy+b5z8h8nRVdOWWR7wTmpLUA="></script><script type=text/javascript src=/lib/clipboard/clipboard.min.11be927cda59c8b6019ebbea838285c5beaf21183ea4b83dbd4e4fbf9413ce4a.js integrity="sha256-Eb6SfNpZyLYBnrvqg4KFxb6vIRg+pLg9vU5Pv5QTzko="></script><script type=text/javascript src=/lib/typeit/typeit.min.491c13689db70b6adb3176a9a792644be7578a2f931521f5cb199d313a21c359.js integrity="sha256-SRwTaJ23C2rbMXapp5JkS+dXii+TFSH1yxmdMTohw1k="></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.e55842a856a6d829feca3c3ad736c136b6c7549e9247274f78aa296259e06e24.js integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" defer></script><script type=text/javascript src=/js/cookieconsent.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=https://mengdemao-github-io.disqus.com/embed.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6QCK4BFMHW",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-6QCK4BFMHW" async></script></div></body></html>